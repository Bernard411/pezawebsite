{% extends 'base.html' %}
{% load static %}

{% block title %}{{ article.title }} - Peza{% endblock %}

{% block meta_description %}{{ article.get_excerpt|striptags|truncatewords:30 }}{% endblock %}

{% block extra_head %}
<!-- Open Graph -->
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
<meta property="og:title" content="{{ article.title }}">
<meta property="og:description" content="{{ article.get_excerpt|striptags }}">
{% if featured_image %}
<meta property="og:image" content="{{ featured_image }}">
{% endif %}

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="{{ request.build_absolute_uri }}">
<meta property="twitter:title" content="{{ article.title }}">
<meta property="twitter:description" content="{{ article.get_excerpt|striptags }}">
{% if featured_image %}
<meta property="twitter:image" content="{{ featured_image }}">
{% endif %}
{% endblock %}


{% block extra_css %}
<style>
  :root {
    --accent-color: #3b82f6;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
  }

  .content-wrapper {
    line-height: 1.8;
    color: #374151;
    font-size: 1.0625rem;
  }
  .content-wrapper > * { margin-bottom: 1.5rem; }
  .content-wrapper p { margin-bottom: 1.5rem; }
  .content-wrapper h1 { font-size: 2.25rem; font-weight: 700; margin-top: 2.5rem; margin-bottom: 1rem; }
  .content-wrapper h2 { font-size: 1.875rem; font-weight: 700; margin-top: 2.25rem; margin-bottom: 1rem; }
  .content-wrapper h3 { font-size: 1.5rem; font-weight: 700; margin-top: 2rem; margin-bottom: 0.75rem; }
  .content-wrapper ul, .content-wrapper ol { padding-left: 2rem; margin: 1.5rem 0; }
  .content-wrapper li { margin-bottom: 0.5rem; }
  .content-wrapper img {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 2rem auto;
    display: block;
  }
  .content-wrapper blockquote {
    border-left: 4px solid var(--accent-color);
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: #6b7280;
  }
  .content-wrapper code {
    background: #f3f4f6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    color: #dc2626;
  }
  .content-wrapper pre {
    background: #1f2937;
    color: #f3f4f6;
    padding: 1.5rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 2rem 0;
    white-space: pre-wrap;
  }
  .content-wrapper pre code { background: none; padding: 0; color: inherit; }
  .content-wrapper table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
  }
  .content-wrapper th, .content-wrapper td {
    border: 1px solid #e5e7eb;
    padding: 0.75rem;
    text-align: left;
  }
  .content-wrapper th {
    background: #f9fafb;
    font-weight: 600;
  }

  .sticky-sidebar { position: sticky; top: 2rem; }
  .ad-placeholder {
    background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
    border: 2px dashed #d1d5db;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
    font-weight: 600;
    font-size: 0.875rem;
    min-height: 280px;
  }
  .image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1rem;
  }
  .image-card {
    position: relative;
    overflow: hidden;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .image-card img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    transition: transform 0.3s;
  }
  .image-card:hover img { transform: scale(1.05); }
  .image-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.5);
    opacity: 0;
    transition: opacity 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .image-card:hover .image-overlay { opacity: 1; }
</style>
{% endblock %}


{% block content %}

<main class="max-w-screen-2xl mx-auto px-4 py-8 md:py-12">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- MAIN CONTENT -->
    <div class="lg:col-span-2 space-y-8">

      <article class="bg-white rounded-xl overflow-hidden border border-gray-200 shadow-sm">

        <!-- Banner Image -->
        {% if article.featured_image %}
        <img src="{{ article.featured_image }}" alt="{{ article.title }}" class="w-full h-48 md:h-64 object-cover">
        {% endif %}

        <div class="p-6 md:p-8">

          <!-- Meta Info -->
          <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600 mb-5">
            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-500 text-white">
              {{ article.category.name|default:"Article" }}
            </span>
            <span><i class='bx bx-time-five'></i> {{ article.read_time }} min read</span>
            <span><i class='bx bx-calendar'></i> {{ article.published_at|date:"M d, Y" }}</span>
            {% if image_count > 0 %}
            <span><i class='bx bx-image'></i> {{ image_count }} image{{ image_count|pluralize }}</span>
            {% endif %}
          </div>

          <!-- Title -->
          <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6">{{ article.title }}</h1>

          <!-- Article Content -->
          <div class="content-wrapper prose max-w-none">
            {{ article.content|safe }}
          </div>

          <!-- Images Gallery -->
          {% if content_images %}
          <div class="mt-10 pt-8 border-t border-gray-200">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
              <i class='bx bx-image'></i> Images ({{ image_count }})
            </h3>
            <div class="image-grid">
              {% for img in content_images %}
              <div class="image-card">
                <img src="{{ img }}" alt="Article image {{ forloop.counter }}">
                <a href="{{ img }}" target="_blank" class="image-overlay">
                  <i class='bx bx-zoom-in text-white text-3xl'></i>
                </a>
              </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Tags -->
          {% if article.tags.all %}
          <div class="mt-8 pt-6 border-t border-gray-200">
            <div class="flex flex-wrap items-center gap-2">
              <span class="font-semibold text-gray-600"><i class='bx bx-purchase-tag'></i> Tags:</span>
              {% for tag in article.tags.all %}
              <a href="{% url 'articles_by_tag' tag=tag.slug %}" class="px-3 py-1 bg-gray-100 rounded-full text-sm hover:bg-gray-200 transition">
                #{{ tag.name }}
              </a>
              {% endfor %}
            </div>
          </div>
          {% endif %}

        </div>
      </article>

      <!-- Image Alert -->
      {% if has_images %}
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r">
        <p class="text-sm text-blue-700 flex items-center gap-2">
          <i class='bx bx-info-circle'></i>
          This article contains {{ image_count }} image{{ image_count|pluralize }}.
        </p>
      </div>
      {% else %}
      <div class="bg-gray-50 border-l-4 border-gray-300 p-4 rounded-r">
        <p class="text-sm text-gray-600 flex items-center gap-2">
          <i class='bx bx-file-blank'></i>
          This is a text-only article.
        </p>
      </div>
      {% endif %}

      <!-- Popular Posts (Compact) -->
      {% include 'partials/_popular_posts.html' %}

    </div>

    <!-- SIDEBAR -->
    <aside class="lg:col-span-1">
      <div class="sticky-sidebar space-y-6">

        <!-- Ad Slot -->
        <div class="ad-placeholder">
          SIDEBAR AD SLOT
        </div>

        <!-- Sidebar Popular Posts -->
        {% include 'partials/_sidebar_popular.html' %}

        <!-- Related Articles -->
        {% if related_articles %}
        <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
          <h3 class="text-xl font-bold mb-4 text-gray-800">Related Articles</h3>
          <div class="space-y-4">
            {% for related in related_articles %}
            <a href="{% url 'article_detail' slug=related.slug %}" class="block group">
              <div class="flex gap-3">
                {% if related.featured_image %}
                <img src="{{ related.featured_image }}" alt="{{ related.title }}" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                {% else %}
                <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                  <i class='bx bx-file text-gray-400'></i>
                </div>
                {% endif %}
                <div class="flex-1 min-w-0">
                  <h4 class="font-medium text-sm line-clamp-2 group-hover:text-blue-600 transition">
                    {{ related.title }}
                  </h4>
                  <p class="text-xs text-gray-500 mt-1">{{ related.published_at|date:"M d" }}</p>
                </div>
              </div>
            </a>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- Newsletter -->
        {% include 'partials/_newsletter.html' %}

      </div>
    </aside>

  </div>
</main>
{% endblock %}